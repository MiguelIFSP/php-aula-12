<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora API</title>
    <style>
        /* Estilos básicos para a calculadora */
        .calculadora {
            width: 300px;
            border: 1px solid #ccc;
            padding: 10px;
            background-color: #f9f9f9;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
        }
        .display {
            width: 100%;
            height: 40px;
            font-size: 24px;
            text-align: right;
            margin-bottom: 10px;
            padding: 5px;
            box-sizing: border-box;
            background-color: #eee;
            border: 1px solid #aaa;
        }
        .botoes {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 5px;
        }
        .botoes button {
            padding: 15px;
            font-size: 18px;
            cursor: pointer;
            border: 1px solid #ccc;
            background-color: #fff;
        }
        .operador, .memoria {
            background-color: #ff9900 !important;
            color: white;
        }
        .igual {
            background-color: #007bff !important;
            color: white;
            grid-column: span 2;
        }
    </style>
</head>
<body>

    <h2>Calculadora com API e Memória (DB)</h2>
    <p>A API deve estar rodando em <code>http://localhost/api/</code></p>

    <div class="calculadora">
        <div id="display" class="display">0</div>
        <div class="botoes">
            <button class="memoria" onclick="acaoMemoria('mr')">MR</button>
            <button class="memoria" onclick="acaoMemoria('mc')">MC</button>
            <button class="memoria" onclick="acaoMemoria('mplus')">M+</button>
            <button class="memoria" onclick="acaoMemoria('mminus')">M-</button>

            <button onclick="limpar()">C</button>
            <button class="operador" onclick="setOperacao('raiz')">√</button>
            <button class="operador" onclick="setOperacao('/')">/</button>
            <button class="operador" onclick="setOperacao('*')">*</button>

            <button onclick="digitar('7')">7</button>
            <button onclick="digitar('8')">8</button>
            <button onclick="digitar('9')">9</button>
            <button class="operador" onclick="setOperacao('-')">-</button>

            <button onclick="digitar('4')">4</button>
            <button onclick="digitar('5')">5</button>
            <button onclick="digitar('6')">6</button>
            <button class="operador" onclick="setOperacao('+')">+</button>

            <button onclick="digitar('1')">1</button>
            <button onclick="digitar('2')">2</button>
            <button onclick="digitar('3')">3</button>
            <button onclick="digitar('0')">0</button>
            <button onclick="digitar('.')">.</button>

            <button class="igual" onclick="calcular()">=</button>
        </div>
    </div>

    <script>
        // Variáveis de estado da calculadora
        let display = document.getElementById('display');
        let valorAtual = '0';
        let valorAnterior = null;
        let operacao = null;
        let aguardandoSegundoValor = false;

        // URL base da sua API
        const URL_BASE = 'http://localhost/api/';

        /**
         * 1. Funções de Manipulação do Display
         */
        function atualizarDisplay(valor) {
            // Limita o número de casas decimais para visualização
            if (String(valor).includes('.')) {
                let partes = String(valor).split('.');
                if (partes[1].length > 10) {
                    valor = parseFloat(valor).toFixed(10);
                }
            }
            display.textContent = valor;
            valorAtual = String(valor);
        }

        function digitar(caractere) {
            if (aguardandoSegundoValor) {
                valorAtual = caractere;
                aguardandoSegundoValor = false;
            } else {
                if (caractere === '.') {
                    if (!valorAtual.includes('.')) {
                        valorAtual += caractere;
                    }
                } else {
                    if (valorAtual === '0' && caractere !== '.') {
                        valorAtual = caractere;
                    } else {
                        valorAtual += caractere;
                    }
                }
            }
            atualizarDisplay(valorAtual);
        }

        function limpar() {
            valorAtual = '0';
            valorAnterior = null;
            operacao = null;
            aguardandoSegundoValor = false;
            atualizarDisplay(valorAtual);
        }

        function setOperacao(novaOperacao) {
            if (valorAnterior === null) {
                valorAnterior = parseFloat(valorAtual);
            } else if (operacao && !aguardandoSegundoValor) {
                // Se já tem uma operação pendente e não está esperando o segundo valor, calcula
                calcular();
                valorAnterior = parseFloat(valorAtual);
            }

            operacao = novaOperacao;
            aguardandoSegundoValor = true;

            // Para operações unárias como raiz, executa imediatamente
            if (novaOperacao === 'raiz') {
                calcular();
            }
        }


        /**
         * 2. Função Principal de Cálculo (Chama a API)
         */
        function calcular() {
            if (operacao === null) return;

            const x = parseFloat(valorAnterior);
            const y = parseFloat(valorAtual);
            let url = '';

            // Lógica para operações unárias (raiz) e binárias
            if (operacao === 'raiz') {
                // Raiz usa apenas o valorAtual
                url = `${URL_BASE}raiz.php?x=${y}`; 
            } else {
                // Operações binárias usam valorAnterior (x) e valorAtual (y)
                let script = '';
                switch (operacao) {
                    case '+': script = 'soma.php'; break;
                    case '-': script = 'subtrai.php'; break;
                    case '*': script = 'multiplica.php'; break;
                    case '/': script = 'divide.php'; break;
                    default: return;
                }
                url = `${URL_BASE}${script}?x=${x}&y=${y}`;
            }

            // Requisição AJAX para a API
            const xhttp = new XMLHttpRequest();
            xhttp.onload = function () {
                const resposta = JSON.parse(this.responseText);
                
                if (resposta.erro) {
                    atualizarDisplay('Erro');
                } else if (resposta.resultado !== undefined) {
                    // Exibe o resultado da API e prepara para a próxima operação
                    const resultadoAPI = String(resposta.resultado);
                    atualizarDisplay(resultadoAPI);
                    valorAnterior = null;
                    operacao = null;
                    aguardandoSegundoValor = false;
                }
            }
            xhttp.open("GET", url);
            xhttp.send();
        }

        /**
         * 3. Funções de Memória (Chamam a API do Banco de Dados)
         */
        function acaoMemoria(tipoAcao) {
            let url = `${URL_BASE}${tipoAcao}.php`;
            
            // Para M+ e M-, precisamos enviar o valor atual do display
            if (tipoAcao === 'mplus' || tipoAcao === 'mminus') {
                const valor = parseFloat(valorAtual);
                url += `?valor=${valor}`;
            }

            const xhttp = new XMLHttpRequest();
            xhttp.onload = function () {
                const resposta = JSON.parse(this.responseText);

                if (resposta.erro) {
                    alert('Erro na memória: ' + resposta.erro);
                } else if (tipoAcao === 'mr' && resposta.resultado !== undefined) {
                    // MR (Memory Recall): Exibe o valor da memória no display
                    atualizarDisplay(resposta.resultado);
                    aguardandoSegundoValor = false;
                    valorAnterior = null;
                } else if (tipoAcao === 'mc' || tipoAcao === 'mplus' || tipoAcao === 'mminus') {
                    // MC, M+, M-: Apenas notifica o usuário (opcional)
                    console.log(`Memória atualizada para: ${resposta.memoria_atual}`);
                }
            }
            xhttp.open("GET", url);
            xhttp.send();
        }

        // Inicializa o display ao carregar
        window.onload = function() {
            atualizarDisplay(valorAtual);
        };
    </script>

</body>
</html>